<!DOCTYPE html>
<html>
<head>
    <title>Noahs Math tools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
body, html {
    margin: 0;
    height: 100%;
    overflow: hidden;

    background: linear-gradient(45deg, #000000, #ff7a00);
    background-size: 300% 300%;
    animation: bgShift 6s ease infinite;
}

@keyframes bgShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
        
        body {
    display: flex;
    justify-content: center;
    align-items: center;
}


        #box {
            color: #aaa;
            height: 20em;
            width: 30em;
            max-width: 80%;
            max-height: 80%;
            background-color: #333;
            border-radius: 0.4em;
            border: 2px solid #555;
            position: relative;
            transition-duration: 0.2s;
            overflow: hidden;
            font-weight: bold;
            font-size: 20px;
            margin: 5px;
            text-align: center;
            padding: 10px;
        }

        #box:hover, #box[drag] {
            border-color: #1AAFFF;
            color: #ddd;
        }

        #input {
            cursor: pointer;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }

        #top {
            margin: 5px;
        }

        select, button {
            padding: 0.6em 0.4em;
            margin: 0.5em;
            width: 15em;
            max-width: 100%;
            font-weight: bold;
            font-size: 16px;
            background-color: #444;
            color: #aaa;
            border-radius: 0.4em;
            border: 1px solid #555;
            cursor: pointer;
            transition-duration: 0.2s;
        }

        select:hover, button:hover {
            background-color: #666;
            color: #ddd;
        }
    </style>
</head>

<body>

    <div id="top"><br></div>

    <div id="box">
        <input type="file" id="input" title="Upload" />
        Drag ROM file or click here
    </div>

    <script>
        let enableDebug = false;
        let enableThreads = false;
        let browserMode;

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        if (parseInt(urlParams.get("debug")) === 1 || urlParams.get("debug") === "true") {
            enableDebug = true;
            console.log("Debug is enabled");
        } else {
            console.log("Debug is disabled");
        }

        if (parseInt(urlParams.get("threads")) === 1 || urlParams.get("threads") === "true") {
            if (window.SharedArrayBuffer) {
                enableThreads = true;
                console.log("Threads are enabled");
            } else {
                console.warn("Threads require cross-origin isolation.");
            }
        } else {
            console.log("Threads are disabled");
        }

        if (urlParams.get("browserMode")) {
            browserMode = urlParams.get("browserMode");
        }

        if (urlParams.get("rom")) {
            console.log(`Loading ROM from URL: roms/${urlParams.get("rom")}`);
            run(false, urlParams.get("rom"));
        }

        async function run(upload, file) {
            const url = upload ? input.files[0] : `roms/${file}`;
            const parts = upload ? input.files[0].name.split(".") : file.split(".");

            const core = await (async (ext) => {
                if (["fds","nes","unif","unf"].includes(ext)) return "nes";
                if (["smc","fig","sfc","gd3","gd7","dx2","bsx","swc"].includes(ext)) return "snes";
                if (["z64","n64"].includes(ext)) return "n64";
                if (["pce"].includes(ext)) return "pce";
                if (["ngp","ngc"].includes(ext)) return "ngp";
                if (["ws","wsc"].includes(ext)) return "ws";
                if (["col","cv"].includes(ext)) return "coleco";
                if (["d64"].includes(ext)) return "vice_x64sc";
                if (["md","sg","smd","gen"].includes(ext)) return "segaMD";
                if (["nds","gba","gb","z64","n64"].includes(ext)) return ext;

                return await new Promise(resolve => {
                    var coreValues = {
                        "Nintendo 64": "n64",
                        "Nintendo Game Boy": "gb",
                        "Nintendo Game Boy Advance": "gba",
                        "Nintendo DS": "nds",
                        "Nintendo Entertainment System": "nes",
                        "Super Nintendo Entertainment System": "snes",
                        "PlayStation": "psx",
                        "Virtual Boy": "vb",
                        "Sega Mega Drive": "segaMD",
                        "Sega Master System": "segaMS",
                        "Sega CD": "segaCD",
                        "Atari Lynx": "lynx",
                        "Sega 32X": "sega32x",
                        "Atari Jaguar": "jaguar",
                        "Sega Game Gear": "segaGG",
                        "Sega Saturn": "segaSaturn",
                        "Atari 7800": "atari7800",
                        "Atari 2600": "atari2600",
                        "Arcade": "arcade",
                        "NEC TurboGrafx-16": "pce",
                        "NEC PC-FX": "pcfx",
                        "NeoGeo Pocket": "ngp",
                        "WonderSwan": "ws",
                        "ColecoVision": "coleco",
                        "Commodore 64": "vice_x64sc",
                        "Commodore 128": "vice_x128",
                        "VIC-20": "vice_xvic",
                        "Plus/4": "vice_xplus4",
                        "PET": "vice_xpet"
                    };

                    if (enableThreads) {
                        coreValues["DOSBOX-PURE"] = "dosbox_pure";
                        coreValues["PSP"] = "ppsspp";
                    }

                    for (let core in coreValues) {
                        if (core.toLowerCase() === ext) resolve(core);
                    }

                    const cores = Object.keys(coreValues).sort();

                    const button = document.createElement("button");
                    const select = document.createElement("select");

                    cores.forEach(type => {
                        const option = document.createElement("option");
                        option.value = coreValues[type];
                        option.textContent = type;
                        select.appendChild(option);
                    });

                    button.onclick = () => resolve(select.value);
                    button.textContent = "Load game";

                    box.innerHTML = "";
                    box.appendChild(select);
                    box.appendChild(button);
                });

            })(parts.pop());

            const div = document.createElement("div");
            const sub = document.createElement("div");
            const script = document.createElement("script");

            sub.id = "game";
            div.id = "display";

            const top = document.getElementById("top");
            top.remove();
            box.remove();

            div.appendChild(sub);
            document.body.appendChild(div);

            window.EJS_player = "#game";
            window.EJS_gameName = parts.shift();
            window.EJS_biosUrl = "";
            window.EJS_gameUrl = url;
            window.EJS_core = core;
            window.EJS_pathtodata = "data/";
            window.EJS_startOnLoaded = true;
            window.EJS_DEBUG_XX = enableDebug;
            window.EJS_disableDatabases = true;
            window.EJS_threads = enableThreads;

            if (browserMode) window.EJS_browserMode = browserMode;

            script.src = "data/loader.js";
            document.body.appendChild(script);
        }

        input.onchange = async () => run(true);
        box.ondragover = () => box.setAttribute("drag", true);
        box.ondragleave = () => box.removeAttribute("drag");
    </script>

</body>
</html>
