<!DOCTYPE html>
<html>
<head>
    <title>Noahs Math Tools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        /* Animated Gradient Background */
        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(45deg, #000000, #ff7a00);
            background-size: 400% 400%;
            animation: gradientMove 4s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: monospace;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Upload Box */
        #box {
            color: #aaa;
            height: 20em;
            width: 30em;
            max-width: 80%;
            max-height: 80%;
            background-color: #333;
            border-radius: 0.4em;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition-duration: 0.2s;
            overflow: hidden;
            font-size: 20px;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        #box:hover, #box[drag] {
            border-color: #1AAFFF;
            color: #ddd;
        }

        #input {
            cursor: pointer;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }

        /* Game Display */
        #display {
            width: 100%;
            height: 100%;
        }

        select, button {
            padding: 0.6em 0.4em;
            margin: 0.5em;
            width: 15em;
            max-width: 100%;
            font-family: monospace;
            font-weight: bold;
            font-size: 16px;
            background-color: #444;
            color: #aaa;
            border-radius: 0.4em;
            border: 1px solid #555;
            cursor: pointer;
            transition-duration: 0.2s;
        }

        select:hover, button:hover {
            background-color: #666;
            color: #ddd;
        }
    </style>
</head>

<body>

    <div id="box">
        <input type="file" id="input" title="Upload" />
        Drag ROM file or click here
    </div>

    <script>
        let enableDebug = false;
        let enableThreads = false;
        let browserMode;

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        if (parseInt(urlParams.get("debug")) === 1 || urlParams.get("debug") === "true") {
            enableDebug = true;
            console.log("Debug is enabled");
        }

        if (parseInt(urlParams.get("threads")) === 1 || urlParams.get("threads") === "true") {
            if (window.SharedArrayBuffer) {
                enableThreads = true;
                console.log("Threads are enabled");
            } else {
                console.warn("Threads require special headers to be set on your server.");
            }
        }

        if (urlParams.get("browserMode")) {
            browserMode = urlParams.get("browserMode");
        }

        if (urlParams.get("rom")) {
            run(false, urlParams.get("rom"));
        }

        /* MAIN ROM LOADER FUNCTION */
        async function run(upload, file) {
            const url = upload ? input.files[0] : `roms/${file}`;
            const parts = upload ? input.files[0].name.split(".") : file.split(".");
            const ext = parts.pop().toLowerCase();

            const core = await (async (ext) => {
                if (["fds", "nes", "unif", "unf"].includes(ext)) return "nes";
                if (["smc", "fig", "sfc", "gd3", "gd7", "dx2", "bsx", "swc"].includes(ext)) return "snes";
                if (["z64", "n64"].includes(ext)) return "n64";
                if (["pce"].includes(ext)) return "pce";
                if (["ngp", "ngc"].includes(ext)) return "ngp";
                if (["ws", "wsc"].includes(ext)) return "ws";
                if (["col", "cv"].includes(ext)) return "coleco";
                if (["d64"].includes(ext)) return "vice_x64sc";
                if (["md", "sg", "smd", "gen"].includes(ext)) return "segaMD";
                if (["nds", "gba", "gb"].includes(ext)) return ext;

                /* Ask user to choose core */
                return await new Promise(resolve => {
                    const coreOptions = {
                        "Nintendo 64": "n64",
                        "Nintendo Game Boy": "gb",
                        "Nintendo Game Boy Advance": "gba",
                        "Nintendo DS": "nds",
                        "Nintendo Entertainment System": "nes",
                        "Super Nintendo": "snes",
                        "PlayStation": "psx",
                        "Virtual Boy": "vb",
                        "Sega Mega Drive": "segaMD",
                        "Sega Master System": "segaMS",
                        "Sega CD": "segaCD",
                        "Atari Lynx": "lynx",
                        "Atari 2600": "atari2600",
                        "Arcade": "arcade",
                        "PC Engine / TurboGrafx": "pce"
                    };

                    const select = document.createElement("select");
                    const btn = document.createElement("button");
                    btn.textContent = "Load Game";

                    for (const label in coreOptions) {
                        const option = document.createElement("option");
                        option.value = coreOptions[label];
                        option.textContent = label;
                        select.appendChild(option);
                    }

                    btn.onclick = () => resolve(select.value);

                    box.innerHTML = "";
                    box.appendChild(select);
                    box.appendChild(btn);
                });
            })(ext);

            /* Replace UI with emulator screen */
            const display = document.createElement("div");
            const game = document.createElement("div");
            game.id = "game";

            display.id = "display";
            display.appendChild(game);

            box.remove();
            document.body.appendChild(display);

            /* EmulatorJS config */
            window.EJS_player = "#game";
            window.EJS_gameName = parts.shift();
            window.EJS_biosUrl = "";
            window.EJS_gameUrl = url;
            window.EJS_core = core;
            window.EJS_pathtodata = "data/";
            window.EJS_startOnLoaded = true;
            window.EJS_DEBUG_XX = enableDebug;
            window.EJS_threads = enableThreads;

            if (browserMode) window.EJS_browserMode = browserMode;

            const script = document.createElement("script");
            script.src = "data/loader.js";
            document.body.appendChild(script);
        }

        /* Drag + Upload behavior */
        input.onchange = () => run(true);

        box.ondragover = () => box.setAttribute("drag", true);
        box.ondragleave = () => box.removeAttribute("drag");
    </script>

</body>
</html>
